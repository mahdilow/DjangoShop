{% extends 'core/base.html' %}

{% block title %}ویرایش حساب کاربری{% endblock %}

{% block content %}
<div class="flex justify-center min-h-screen bg-gray-800">
    <div class="w-full max-w-6xl p-6 lg:p-10">
        <div class="mb-8 flex items-center justify-between">
            <h1 class="text-3xl text-blue-400 font-bold">ویرایش حساب کاربری</h1>
            <a href="{% url 'myaccount' %}" class="text-gray-400 hover:text-blue-400 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
            </a>
        </div>

        <form method="post" action="." class="space-y-6 bg-gray-900 p-8 rounded-xl shadow-lg border border-gray-700">
            {% csrf_token %}

            <!-- Profile Information Section -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="space-y-2">
                    <label class="text-gray-300 block">نام:</label>
                    <input name="first_name" 
                           value="{{ request.user.first_name }}" 
                           type="text" 
                           class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                           placeholder="نام خود را وارد کنید">
                </div>

                <div class="space-y-2">
                    <label class="text-gray-300 block">نام خانوادگی:</label>
                    <input name="last_name" 
                           value="{{ request.user.last_name }}" 
                           type="text" 
                           class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                           placeholder="نام خانوادگی خود را وارد کنید">
                </div>
            </div>

            <div class="space-y-2">
                <label class="text-gray-300 block">نام کاربری:</label>
                <input name="username" 
                       value="{{ request.user.username }}" 
                       type="text" 
                       class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                       placeholder="نام کاربری خود را وارد کنید">
            </div>

            <div class="space-y-2">
                <label class="text-gray-300 block">ایمیل:</label>
                <input name="email" 
                       value="{{ request.user.email }}" 
                       type="email" 
                       class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                       placeholder="ایمیل خود را وارد کنید">
            </div>

            <!-- Phone Number Section -->
            <div class="space-y-2">
                <label class="text-gray-300 block">شماره تلفن:</label>
                <div class="relative">
                    {% if request.user.phone_number %}
                        <div class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-gray-400 flex items-center justify-between">
                            <span>{{ request.user.phone_number }}</span>
                            <span class="flex items-center text-green-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                </svg>
                                تایید شده
                            </span>
                        </div>
                    {% else %}
                        <div class="flex space-x-2 space-x-reverse">
                            <input name="phone_number" 
                                   type="text" 
                                   class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all" 
                                   placeholder="شماره تلفن خود را وارد کنید"
                                   hx-trigger="keyup changed delay:500ms"
                                   hx-get="/validate-phone"
                                   hx-target="#phone-validation">
                            <button type="button" 
                                    onclick="sendOTP()" 
                                    class="px-6 rounded-lg text-white bg-green-600 hover:bg-green-700 transition-all duration-200 flex items-center space-x-2 space-x-reverse disabled:opacity-50 disabled:cursor-not-allowed"
                                    id="send-otp-btn">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" />
                                </svg>
                                <span>ارسال کد</span>
                            </button>
                        </div>
                        <div id="phone-validation" class="mt-2 text-sm"></div>
                    {% endif %}
                </div>
            </div>

            <!-- OTP Section -->
            {% if not request.user.phone_number %}
                <div id="otp-section" class="hidden space-y-4 p-6 border border-gray-700 rounded-lg bg-gray-800/50">
                    <div class="space-y-2">
                        <label class="text-gray-300 block">کد تایید:</label>
                        <div class="flex space-x-4 space-x-reverse">
                            <input name="otp" 
                                   type="text" 
                                   maxlength="6"
                                   class="w-full rounded-lg border border-gray-700 bg-gray-800 p-4 text-lg text-white shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all text-center tracking-widest" 
                                   placeholder="- - - - - -">
                            <div class="text-gray-400 flex items-center" id="timer"></div>
                        </div>
                    </div>
                    <p class="text-gray-400 text-sm">کد تایید به شماره موبایل شما ارسال شد</p>
                </div>
            {% endif %}

            <!-- Toast Notifications -->
            <div id="toast-container" class="fixed top-4 left-4 z-50 space-y-4"></div>

            {% if messages %}
                <div class="space-y-2">
                    {% for message in messages %}
                        <div class="p-4 rounded-lg {% if message.tags == 'success' %}bg-green-600/20 text-green-400{% else %}bg-red-600/20 text-red-400{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}

            <div class="flex justify-end pt-6">
                <button type="submit" 
                        class="py-4 px-8 rounded-lg text-white bg-blue-600 hover:bg-blue-700 transition-all duration-200 flex items-center space-x-2 space-x-reverse">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span>ثبت تغییرات</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Scripts -->
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script>
let timerInterval;

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `transform transition-all duration-300 ease-out scale-95 opacity-0 
                      p-4 rounded-lg shadow-lg max-w-sm 
                      ${type === 'success' ? 'bg-green-600' : 
                        type === 'error' ? 'bg-red-600' : 
                        type === 'info' ? 'bg-blue-600' : 'bg-yellow-600'} 
                      text-white flex items-center space-x-2 space-x-reverse`;
    
    toast.innerHTML = `
        <div class="flex-1">${message}</div>
        <button onclick="this.parentElement.remove()" class="text-white hover:text-gray-200">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
    `;
    
    document.getElementById('toast-container').appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.classList.remove('scale-95', 'opacity-0');
        toast.classList.add('scale-100', 'opacity-100');
    }, 10);

    // Auto remove after 5 seconds
    setTimeout(() => {
        toast.classList.add('scale-95', 'opacity-0');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

async function sendOTP() {
    const phoneNumber = document.querySelector('input[name="phone_number"]').value;
    const button = document.getElementById('send-otp-btn');
    
    if (!phoneNumber) {
        showToast('لطفا شماره تلفن را وارد کنید', 'error');
        return;
    }

    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = '<svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    try {
        const response = await fetch('/auth/phone-login/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({ phone_number: phoneNumber })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            if (data.is_new_user === false) {
                showToast('این شماره تلفن قبلاً در سیستم ثبت شده است', 'error');
            } else {
                document.getElementById('otp-section').classList.remove('hidden');
                showToast('کد تایید با موفقیت ارسال شد', 'success');
                startTimer(120); // 2 minutes timer
            }
        } else {
            showToast(data.error || 'خطا در ارسال کد تایید', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('خطا در ارسال کد تایید', 'error');
    } finally {
        button.disabled = false;
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg><span>ارسال کد</span>';
    }
}

function startTimer(duration) {
    clearInterval(timerInterval);
    let timer = duration;
    const timerElement = document.getElementById('timer');
    
    function updateTimer() {
        const minutes = parseInt(timer / 60, 10);
        const seconds = parseInt(timer % 60, 10);
        
        timerElement.textContent = minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
        
        if (--timer < 0) {
            clearInterval(timerInterval);
            timerElement.textContent = "زمان به پایان رسید";
        }
    }
    
    updateTimer();
    timerInterval = setInterval(updateTimer, 1000);
}
</script>
{% endblock %}